<!DOCTYPE html>
<html>
<head>
    <title>Vehicle Entry</title>
    <style>
        video, canvas { width: 300px; border: 1px solid #ccc; }
        .section { margin-bottom: 20px; }
        button { margin-top: 10px; }
    </style>
</head>
<body>

<h3>Vehicle Entry</h3>

<form method="POST" enctype="multipart/form-data" id="entryForm">
{% csrf_token %}

<label>Vehicle Name</label><br>
<input type="text" name="vehicle_name" required><br><br>

<label>Vehicle Number</label><br>
<input type="text" name="vehicle_number_manual"><br><br>

<label>Driver Name</label><br>
<input type="text" name="driver_name"><br><br>

<label>Gate No</label><br>
<input type="text" name="gate_no" required><br><br>

<hr>


<div class="section">
    <h4>Front Image</h4>
    <video id="frontVideo"></video><br>
    <button type="button" onclick="startCamera('front')"> Camera</button>
    <button type="button" onclick="capture('front')">Capture Front</button>
</div>


<div class="section">
    <h4>Rear Image</h4>
    <video id="rearVideo"></video><br>
    <button type="button" onclick="startCamera('rear')"> Camera</button>
    <button type="button" onclick="capture('rear')">Capture Rear</button>
</div>


<div class="section">
    <h4>Side Image</h4>
    <video id="sideVideo"></video><br>
    <button type="button" onclick="startCamera('side')"> Camera</button>
    <button type="button" onclick="capture('side')">Capture Side</button>
</div>


<div class="section">
    <h4>Driver Image (Optional)</h4>
    <video id="driverVideo"></video><br>
    <button type="button" onclick="startCamera('driver')"> Camera</button>
    <button type="button" onclick="capture('driver')">Capture Driver</button>
</div>

<div id="hiddenFiles"></div>

<button type="submit">Generate Entry Pass</button>
</form>

<script>
const streams = {};


async function startCamera(type) {
    if (streams[type]) return; 

    const video = document.getElementById(type + "Video");
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });

    streams[type] = stream;
    video.srcObject = stream;
    video.play();
}


function stopCamera(type) {
    if (!streams[type]) return;

    streams[type].getTracks().forEach(track => track.stop());
    streams[type] = null;

    const video = document.getElementById(type + "Video");
    video.srcObject = null;
}


function capture(type) {
    if (!streams[type]) {
        alert("Open camera first");
        return;
    }

    const video = document.getElementById(type + "Video");
    const canvas = document.createElement("canvas");

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext("2d").drawImage(video, 0, 0);

    canvas.toBlob(blob => {
        const input = document.createElement("input");
        input.type = "file";
        input.name = (type === "driver") ? "driver_image" : type + "_images";

        const file = new File([blob], `${type}_${Date.now()}.jpg`, {
            type: "image/jpeg"
        });

        const dt = new DataTransfer();
        dt.items.add(file);
        input.files = dt.files;

        document.getElementById("hiddenFiles").appendChild(input);

    
        stopCamera(type);

        alert(type.toUpperCase() + " image captured");
    }, "image/jpeg");
}
</script>

</body>
</html>