{% extends 'base_user.html' %}
{% load static i18n %}

{% block title %}{% trans "Supplier Gate Entry" %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/user/security/supplier_gate_entry_create.css' %}">
{% endblock %}

{% block content %}

<div class="gate-entry-page">

    <!-- HEADER -->
    <div class="wh-header-section">
        <div class="wh-header-left">
            <h1><span>{% trans "Supplier " %}</span>{% trans "Gate Entry" %}</h1>
        </div>
        <div class="wh-header-right">
            <a href="javascript:history.back()" class="btn-back">
                <i class="bi bi-arrow-left"></i> {% trans "Back" %}
            </a>
        </div>
    </div>

    <!-- FORM CARD -->
    <div class="form-card grid-layout">

        <!-- ILLUSTRATION -->
        <div class="form-illustration">
            <img src="{% static 'images/security-gate-entry.png' %}" alt="Supplier Gate Entry">
            <h3>{% trans "Supplier" %}<span>{% trans " Gate Entry" %}</span></h3>
            <span class="dis-id">
                {% trans "PO Number" %}: {{ dispatch.purchase_order.po_number }}
            </span>
            <p>{% trans "Record supplier vehicle entry details for secure inbound tracking." %}</p>
        </div>

        <!-- FORM -->
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}

            <div class="form-grid">

                <div class="form-group">
                    <label>{% trans "Vehicle Number" %}</label>
                    <input type="text" name="vehicle_number" required>
                </div>

                <div class="form-group">
                    <label>{% trans "Driver Name" %}</label>
                    <input type="text" name="driver_name" required>
                </div>

                <div class="form-group">
                    <label>{% trans "Driver ID Number" %}</label>
                    <input type="text" name="driver_id_number" required>
                </div>

                <div class="form-group">
                    <label>{% trans "Gate Pass Number" %}</label>
                    <input type="text" name="gate_pass_number">
                </div>

                <!-- PO Verified -->
                <div class="camera-group">
                    <div class="qc-check">
                        <input type="checkbox" name="po_verified">
                        <label>{% trans "PO Verified" %}</label>
                    </div>
                </div>

                <!-- PO Proof -->
                <div class="camera-group">
                    <div class="qc-check">
                        <label>{% trans "PO Proof" %}</label>
                    </div>
                    <div class="qc-image">
                        <img id="po-proof-preview" class="preview-img" hidden>
                        <button type="button" class="camera-btn" onclick="openCamera('po-proof')">
                            ðŸ“· {% trans "Take Photo" %}
                        </button>
                        <input type="file" name="po_proof" id="po-proof-input" hidden>
                    </div>
                </div>

                <!-- Vehicle Front -->
                <div class="camera-group">
                    <div class="qc-check">
                        <label>{% trans "Vehicle Photo (Front)" %}</label>
                    </div>
                    <div class="qc-image">
                        <img id="vehicle-front-preview" class="preview-img" hidden>
                        <button type="button" class="camera-btn" onclick="openCamera('vehicle-front')">
                            ðŸ“· {% trans "Take Photo" %}
                        </button>
                        <input type="file" name="vehicle_photo_front" id="vehicle-front-input" hidden>
                    </div>
                </div>

                <!-- Vehicle Rear -->
                <div class="camera-group">
                    <div class="qc-check">
                        <label>{% trans "Vehicle Photo (Rear)" %}</label>
                    </div>
                    <div class="qc-image">
                        <img id="vehicle-rear-preview" class="preview-img" hidden>
                        <button type="button" class="camera-btn" onclick="openCamera('vehicle-rear')">
                            ðŸ“· {% trans "Take Photo" %}
                        </button>
                        <input type="file" name="vehicle_photo_rear" id="vehicle-rear-input" hidden>
                    </div>
                </div>

                <!-- Driver ID -->
                <div class="camera-group">
                    <div class="qc-check">
                        <label>{% trans "Driver ID Proof" %}</label>
                    </div>
                    <div class="qc-image">
                        <img id="driver-id-preview" class="preview-img" hidden>
                        <button type="button" class="camera-btn" onclick="openCamera('driver-id')">
                            ðŸ“· {% trans "Take Photo" %}
                        </button>
                        <input type="file" name="driver_photo" id="driver-id-input" hidden>
                    </div>
                </div>

            </div>

            <div class="form-actions">
                <button type="submit" class="action-btn submit">
                    {% trans "Create Gate Entry" %}
                </button>
            </div>
        </form>
    </div>
</div>

<!-- CAMERA MODAL -->
<div class="camera-modal" id="camera-modal">
    <div class="camera-box">
        <video id="camera-video" autoplay playsinline></video>
        <canvas id="camera-canvas" hidden></canvas>

        <div class="camera-actions">
            <button class="cancel-btn" onclick="closeCamera()">âœ– Cancel</button>
            <button class="retake-btn" id="retakeBtn" onclick="retakePhoto()" hidden>ðŸ”„ Retake</button>
            <button class="confirm-btn" id="confirmBtn" onclick="confirmPhoto()" hidden>âœ” Confirm</button>
            <button class="capture-btn" id="captureBtn" onclick="capturePhoto()">ðŸ“¸ Capture</button>
        </div>
    </div>
</div>

<!-- CAMERA JS -->
<script>
let stream;
let activeInput, activePreview;

const cameraModal = document.getElementById('camera-modal');
const cameraVideo = document.getElementById('camera-video');
const cameraCanvas = document.getElementById('camera-canvas');
const captureBtn = document.getElementById('captureBtn');
const confirmBtn = document.getElementById('confirmBtn');
const retakeBtn = document.getElementById('retakeBtn');

function openCamera(prefix) {
    activeInput = document.getElementById(prefix + '-input');
    activePreview = document.getElementById(prefix + '-preview');
    cameraModal.style.display = 'flex';

    navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: "environment" } },
        audio: false
    }).then(s => {
        stream = s;
        cameraVideo.srcObject = stream;
    }).catch(() => {
        alert("Camera permission denied");
        closeCamera();
    });
}

function capturePhoto() {
    cameraCanvas.width = cameraVideo.videoWidth;
    cameraCanvas.height = cameraVideo.videoHeight;
    cameraCanvas.getContext('2d').drawImage(cameraVideo, 0, 0);

    cameraVideo.hidden = true;
    cameraCanvas.hidden = false;
    captureBtn.hidden = true;
    confirmBtn.hidden = false;
    retakeBtn.hidden = false;
}

function confirmPhoto() {
    cameraCanvas.toBlob(blob => {
        const file = new File([blob], "photo.jpg", { type: "image/jpeg" });
        const dt = new DataTransfer();
        dt.items.add(file);
        activeInput.files = dt.files;

        activePreview.src = URL.createObjectURL(file);
        activePreview.hidden = false;
        closeCamera();
    }, "image/jpeg", 0.9);
}

function retakePhoto() {
    cameraCanvas.hidden = true;
    cameraVideo.hidden = false;
    captureBtn.hidden = false;
    confirmBtn.hidden = true;
    retakeBtn.hidden = true;
}

function closeCamera() {
    cameraModal.style.display = 'none';
    if (stream) stream.getTracks().forEach(t => t.stop());
    cameraVideo.hidden = false;
    cameraCanvas.hidden = true;
    captureBtn.hidden = false;
    confirmBtn.hidden = true;
    retakeBtn.hidden = true;
}
</script>

{% endblock %}
