{% extends 'base_user.html' %}
{% load static i18n %}

{% block title %}{% trans "Finance Dashboard" %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/user/finance/finance.css' %}">
<link rel="stylesheet" href="{% static 'css/user_dashboard_table.css' %}">

{% endblock %}

{% block content %}

<div class="db-header">
  <h1><span>{% trans "Finance" %}</span> {% trans "Officer" %}</h1>
  <p>{% trans "Monitor financial performance, revenue trends, expenses, and profit analytics." %}</p>
</div>

<div class="dashboard-layout">
  <!-- Left Section -->
  <div class="left-section">
  
    <div class="im-cards">

      <!-- TOTAL REVENUE -->
      <div class="im-card fade-up">
        <div class="maint-card-bubble"></div>
          <div class="im-card-image">
            <img src="{% static 'images/total-revenue.png' %}" alt="card-image">
          </div>
          <div class="im-info">
              <h4>{% trans "Total Revenue (Today)" %}</h4>
              <p class="im-number">₹ {{ revenue_today|default:"0" }}</p>
              <span class="im-sub">
                {% trans "This month:" %} ₹ {{ revenue_month|default:"0" }}
              </span>
          </div>
      </div>
    
      <!-- OPERATIONAL EXPENSES -->
      <div class="im-card fade-up delay-1">
        <div class="maint-card-bubble"></div>
          <div class="im-card-image">
            <img src="{% static 'images/operational-expense.png' %}" alt="card-image">
          </div>
          <div class="im-info">
              <h4>{% trans "Operational Expenses" %}</h4>
              <p class="im-number">₹ {{ expenses_today|default:"0" }}</p>
              <span class="im-sub">
                {% trans "This month:" %} ₹ {{ expenses_month|default:"0" }}
              </span>
          </div>
      </div>
    
      <!-- OUTSTANDING PAYMENTS -->
      <div class="im-card fade-up delay-2">
        <div class="maint-card-bubble"></div>
          <div class="im-card-image">
            <img src="{% static 'images/outstanding-payments.png' %}" alt="card-image">
          </div>
          <div class="im-info">
              <h4>{% trans "Outstanding Payments" %}</h4>
              <p class="im-number">₹ {{ outstanding_amount|default:"0" }}</p>
              <span class="im-sub">
                {% trans "Overdue invoices:" %} {{ overdue_invoices|default:"0" }}
              </span>
          </div>
      </div>


      <div class="im-card fade-up">
        <div class="maint-card-bubble"></div>
        <div class="im-info">
          <h4>Net Profit / Margin</h4>
          <p class="im-number small">₹ {{ net_profit|default:"0.00" }}</p>
          <span class="im-sub">
            Net margin: {{ profit_margin|default:"0" }}%
          </span>
        </div>
      </div>
      
      <div class="im-card fade-up">
        <div class="maint-card-bubble"></div>
        <div class="im-info">
          <h4>Inventory Valuation</h4>
          <p class="im-number small">₹ {{ inventory_value|default:"0.00" }}</p>
          <span class="im-sub">
            Current inventory value
          </span>
        </div>
      </div>
      
      <div class="im-card fade-up">
        <div class="maint-card-bubble"></div>
        <div class="im-info">
          <h4>Inventory Holding Cost</h4>
          <p class="im-number small">₹ {{ inventory_holding_cost|default:"0.00" }}</p>
          <span class="im-sub">
            Holding & carrying cost
          </span>
        </div>
      </div>
      
      <div class="im-card fade-up">
        <div class="maint-card-bubble"></div>
        <div class="im-info">
          <h4>Order Fulfillment Cost</h4>
          <p class="im-number small">₹ {{ fulfillment_cost|default:"0.00" }}</p>
          <span class="im-sub">
            Order fulfilment cost
          </span>
        </div>
      </div>
      
      <div class="im-card fade-up">
        <div class="maint-card-bubble"></div>
        <div class="im-info">
          <h4>Return & Damage Cost</h4>
          <p class="im-number small">₹ {{ return_damage_cost|default:"0.00" }}</p>
          <span class="im-sub">
            Return & damage loss
          </span>
        </div>
      </div>
      
      <div class="im-card fade-up">
        <div class="maint-card-bubble"></div>
        <div class="im-info">
          <h4>Cost per Order</h4>
          <p class="im-number small">₹ {{ cost_per_order|default:"0.00" }}</p>
          <span class="im-sub">
            Cost per order
          </span>
        </div>
      </div>
      

    </div>
    


  <aside class="quick-actions responsive">
    <div class="quick-action-heading">
      <h3>{% trans "Quick Actions" %}</h3>
    </div>
    <div class="actions-grid">
      <!-- Django links as you already have -->
      {% if "Add Stock" in allowed_functions %}
        <a href="{% url 'warehouse_manager:add_stock' %}" class="action-button">{% trans "Add Stock" %}</a>
      {% endif %}
      {% if "View Stock" in allowed_functions %}
        <a href="{% url 'warehouse_manager:view_stock' %}" class="action-button">{% trans "View Stock" %}</a>
      {% endif %}
      {% if "View Sales Orders" in allowed_functions %}
        <a href="{% url 'warehouse_manager:sales_order_list' %}" class="action-button">{% trans "View Sales Orders" %}</a>
      {% endif %}
      {% if "View Picklist" in allowed_functions %}
        <a href="{% url 'warehouse_manager:picklist_list' %}" class="action-button">{% trans "View Picklist" %}</a>
      {% endif %}
      {% if "Create Sales Order" in allowed_functions %}
        <a href="{% url 'salesofficer:create_sales_order' %}" class="action-button">{% trans "Create Sales Order" %}</a>
      {% endif %}
      {% if "Sales Orders" in allowed_functions %}
        <a href="{% url 'salesofficer:list_sales_orders' %}" class="action-button">{% trans "Sales Orders" %}</a>
      {% endif %}

      {% if "Ready For Delivery" in allowed_functions %}
        <a href="{% url 'salesofficer:ready_for_delivery' %}" class="action-button">{% trans "Assign Delivery Boy" %}</a>
      {% endif %}

      {% if "Create Purchase Order" in allowed_functions %}
        <a href="{% url 'procurement_officer:purchaseorder_create' %}" class="action-button">{% trans "New Purchase Order" %}</a>
      {% endif %}
    
      {% if "View Purchase Order List" in allowed_functions %}
        <a href="{% url 'procurement_officer:purchaseorder_list' %}" class="action-button">{% trans "Purchase Order List" %}</a>
      {% endif %}
    
      {% if "Create GRN" in allowed_functions %}
        <a href="{% url 'procurement_officer:create_grn' %}" class="action-button">{% trans "Create GRN" %}</a>
      {% endif %}
    
      {% if "View GRN" in allowed_functions %}
        <a href="{% url 'procurement_officer:grn_list' %}" class="action-button">{% trans "View GRN" %}</a>
      {% endif %}
    
      {% if "Review GRN" in allowed_functions %}
        <a href="{% url 'grn_review_list' %}" class="action-button">{% trans "Review GRN" %}</a>
      {% endif %}
    
      {% if "View Delivery List" in allowed_functions %}
        <a href="{% url 'delivery_staff:all_deliveries' %}" class="action-button">{% trans "Delivery Orders" %}</a>
      {% endif %}
      <!-- dummy buttons add here  -->
      <!-- dummy buttons add here  -->
       <a href="{% url 'finance:rma' %}" class="action-button">{% trans "RMA" %}</a>
      <a href="{% url 'finance:invoice_list' %}" class="action-button">{% trans "Invoice List" %}</a>
      <a href="{% url 'finance:purchase_invoice_list' %}" class="action-button">{% trans "Purchase Invoice List" %}</a>
      <a href="{% url 'finance:qc_done_items' %}" class="action-button">{% trans "QC Done Items" %}</a>
      <!-- dummy buttons add here  -->
       <a href="{{ tax_registration_url }}" target="_blank" class="action-button special-register-btn">
    {% trans "Register " %}{{ tax_code }}
</a>
      <a href="#" class="action-button">{% trans "Create Sales Invoice" %}</a>
      <a href="#" class="action-button">{% trans "Create Purchase Invoice" %}</a>
      <a href="#" class="action-button">{% trans "View Credit/Debit Notes" %}</a>
      <a href="#" class="action-button">{% trans "Record Payments" %}</a>
      <a href="#" class="action-button">{% trans "Upload Bank Proof" %}</a>
      <a href="#" class="action-button">{% trans "Generate VAT Report" %}</a>
      <a href="#" class="action-button">{% trans "GST Error Alerts" %}</a>
      <a href="#" class="action-button">{% trans "Inventory Valuation" %}</a>
      <a href="#" class="action-button">{% trans "COGS Report" %}</a>
      <a href="#" class="action-button">{% trans "Profit & Loss" %}</a>
      <a href="#" class="action-button">{% trans "AR/AP Aging" %}</a>
      <a href="#" class="action-button">{% trans "Retry Tally Sync" %}</a>
      <a href="#" class="action-button">{% trans "View Sync Errors" %}</a>
      <!-- GST / VAT Register Button -->


    </div>
    <div class="quick-actions-img">
      <img src="{% static 'images/quick-actions.png' %}" alt="quick-actions-img">
    </div>
  </aside>

  <!----------------------------------- graph  -------------------------------------->
    
  <section class="finance-section">

    <div class="finance-header">
      <h2>Financial Performance & Cost Analytics</h2>
      <p>Revenue, costs, profitability, inventory valuation and holding expenses</p>
    </div>
  
    <div class="finance-grid">
  
      <!-- GRAPH 1: REVENUE vs COST -->
      <div class="finance-card">
        <h3>Revenue vs Operational Cost Trend</h3>
        <div class="chart-box">
          <canvas id="revenueCostChart"></canvas>
        </div>
      </div>
  
      <!-- GRAPH 2: MONTHLY PROFIT TREND -->
      <div class="finance-card">
        <h3>Monthly Profit Trend</h3>
        <div class="chart-box">
          <canvas id="profitTrendChart"></canvas>
        </div>
      </div>
  
      <!-- GRAPH 3: PROFITABILITY ANALYSIS -->
      <div class="finance-card">
        <h3>Profitability Analysis</h3>
        <div class="chart-box">
          <canvas id="profitabilityChart"></canvas>
        </div>
      </div>
  
      <!-- GRAPH 4: INVENTORY VALUE -->
      <div class="finance-card">
        <h3>Inventory Value Over Time</h3>
        <div class="chart-box">
          <canvas id="inventoryValueChart"></canvas>
        </div>
      </div>
  
      <!-- GRAPH 5: INVENTORY HOLDING COST -->
      <div class="finance-card">
        <h3>Inventory Holding & Carrying Cost</h3>
        <div class="chart-box">
          <canvas id="holdingCostChart"></canvas>
        </div>
      </div>
  
    </div>
  </section>
  

<!-------------------- recent activities table ------------------>
<div class="recent-activities">
  <h2>{% trans "Recent Activities" %}</h2>
 <!-- TABLE PREVIEW SECTION -->
  <div class="dashboard-table-wrap">

    <div class="table-scroll">
      <table class="dashboard-table">
        <thead>
          <tr>
            <th>Activity</th>
            <th>Reference</th>
            <th>Amount</th>
            <th>Status</th>
            <th>Time</th>
          </tr>
        </thead>

        <tbody>
          <tr>
            <td>Invoice Generated</td>
            <td>INV-3098</td>
            <td>₹45,200</td>
            <td><span class="badge info">Issued</span></td>
            <td>Today, 09:30 AM</td>
          </tr>

          <tr>
            <td>Payment Received</td>
            <td>ORD-5521</td>
            <td>₹32,000</td>
            <td><span class="badge success">Paid</span></td>
            <td>Today, 10:15 AM</td>
          </tr>

          <tr>
            <td>COD Collected</td>
            <td>DEL-8871</td>
            <td>₹3,200</td>
            <td><span class="badge success">Collected</span></td>
            <td>Today, 11:00 AM</td>
          </tr>

          <tr>
            <td>Vendor Payment</td>
            <td>PO-1427</td>
            <td>₹18,750</td>
            <td><span class="badge pending">Pending Approval</span></td>
            <td>Yesterday, 06:10 PM</td>
          </tr>

          <tr>
            <td>Expense Logged</td>
            <td>EXP-094</td>
            <td>₹4,500</td>
            <td><span class="badge warning">Review Required</span></td>
            <td>Yesterday, 04:35 PM</td>
          </tr>

          <!-- Empty state -->
          <!--
          <tr>
            <td colspan="5" class="no-box">No Recent activities yet.</td>
          </tr>
          -->
        </tbody>
      </table>
    </div>
  </div>  
</div>

<!-- ---------------------------------------------------------- -->
</div>

  <!-- Right Section -->
  <div class="right-section">
    <aside class="quick-actions">
      <div class="quick-action-heading">
        <h3>{% trans "Quick Actions" %}</h3>
      </div>
      <div class="actions-grid">
        <!-- Django links as you already have -->
        {% if "Add Stock" in allowed_functions %}
          <a href="{% url 'warehouse_manager:add_stock' %}" class="action-button">{% trans "Add Stock" %}</a>
        {% endif %}
        {% if "View Stock" in allowed_functions %}
          <a href="{% url 'warehouse_manager:view_stock' %}" class="action-button">{% trans "View Stock" %}</a>
        {% endif %}
        {% if "View Sales Orders" in allowed_functions %}
          <a href="{% url 'warehouse_manager:sales_order_list' %}" class="action-button">{% trans "View Sales Orders" %}</a>
        {% endif %}
        {% if "View Picklist" in allowed_functions %}
          <a href="{% url 'warehouse_manager:picklist_list' %}" class="action-button">{% trans "View Picklist" %}</a>
        {% endif %}
        {% if "Create Sales Order" in allowed_functions %}
          <a href="{% url 'salesofficer:create_sales_order' %}" class="action-button">{% trans "Create Sales Order" %}</a>
        {% endif %}
        {% if "Sales Orders" in allowed_functions %}
          <a href="{% url 'salesofficer:list_sales_orders' %}" class="action-button">{% trans "Sales Orders" %}</a>
        {% endif %}

        {% if "Ready For Delivery" in allowed_functions %}
          <a href="{% url 'salesofficer:ready_for_delivery' %}" class="action-button">{% trans "Assign Delivery Boy" %}</a>
        {% endif %}

        {% if "Create Purchase Order" in allowed_functions %}
          <a href="{% url 'procurement_officer:purchaseorder_create' %}" class="action-button">{% trans "New Purchase Order" %}</a>
        {% endif %}
      
        {% if "View Purchase Order List" in allowed_functions %}
          <a href="{% url 'procurement_officer:purchaseorder_list' %}" class="action-button">{% trans "Purchase Order List" %}</a>
        {% endif %}
      
        {% if "Create GRN" in allowed_functions %}
          <a href="{% url 'procurement_officer:create_grn' %}" class="action-button">{% trans "Create GRN" %}</a>
        {% endif %}
      
        {% if "View GRN" in allowed_functions %}
          <a href="{% url 'procurement_officer:grn_list' %}" class="action-button">{% trans "View GRN" %}</a>
        {% endif %}
      
        {% if "Review GRN" in allowed_functions %}
          <a href="{% url 'grn_review_list' %}" class="action-button">{% trans "Review GRN" %}</a>
        {% endif %}
      
        {% if "View Delivery List" in allowed_functions %}
          <a href="{% url 'delivery_staff:all_deliveries' %}" class="action-button">{% trans "Delivery Orders" %}</a>
        {% endif %}
        <!-- dummy buttons add here  -->
         <a href="{% url 'finance:rma' %}" class="action-button">{% trans "RMA" %}</a>
        <a href="{% url 'finance:invoice_list' %}" class="action-button">{% trans "Invoice List" %}</a>
        <a href="{% url 'finance:purchase_invoice_list' %}" class="action-button">{% trans "Purchase Invoice List" %}</a>
        <a href="{% url 'finance:qc_done_items' %}" class="action-button">{% trans "QC Done Items" %}</a>
        <a href="{{ tax_registration_url }}" target="_blank" class="action-button special-register-btn">
    {% trans "Register " %}{{ tax_code }}
</a>

                <!-- dummy buttons add here  -->
      <a href="#" class="action-button">{% trans "Create Sales Invoice" %}</a>
      <a href="#" class="action-button">{% trans "Create Purchase Invoice" %}</a>
      <a href="#" class="action-button">{% trans "View Credit/Debit Notes" %}</a>
      <a href="#" class="action-button">{% trans "Record Payments" %}</a>
      <a href="#" class="action-button">{% trans "Upload Bank Proof" %}</a>
      <a href="#" class="action-button">{% trans "Generate VAT Report" %}</a>
      <a href="#" class="action-button">{% trans "GST Error Alerts" %}</a>
      <a href="#" class="action-button">{% trans "Inventory Valuation" %}</a>
      <a href="#" class="action-button">{% trans "COGS Report" %}</a>
      <a href="#" class="action-button">{% trans "Profit & Loss" %}</a>
      <a href="#" class="action-button">{% trans "AR/AP Aging" %}</a>
      <a href="#" class="action-button">{% trans "Retry Tally Sync" %}</a>
      <a href="#" class="action-button">{% trans "View Sync Errors" %}</a>
      </div>
      <div class="quick-actions-img">
        <img src="{% static 'images/quick-actions.png' %}" alt="quick-actions-img">
      </div>
    </aside>
  </div>

</div>

<!-- SESSION TIMER BOX -->
<!-- SESSION EXPIRY POPUP -->
<div id="sessionPopupOverlay"
   style="
      display:none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(2px);
      z-index: 9998;
   ">
</div>

<div id="sessionPopup"
   style="
      display:none;
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 25px 35px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.3);
      text-align: center;
      z-index: 9999;
      width: 340px;
   ">
  <h3 style="margin-bottom: 10px; color:#b30000;">Session Expiring</h3>
  <p style="margin-bottom: 10px;">
      You have been inactive. You will be logged out in:
  </p>

  <div style="
      font-size: 28px;
      font-weight: bold;
      color: #d00000;
      margin-bottom: 15px;
  ">
      <span id="popupCountdown">05:00</span>
  </div>

  <button onclick="stayLoggedIn()" style="
      padding: 8px 20px;
      background: #007bff;
      border: none;
      color: white;
      border-radius: 8px;
      font-size: 15px;
      cursor: pointer;
  ">Stay Logged In</button>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  let idleTime = 0;
  const idleLimit = 120; // 2 minutes inactivity
  let logoutTimer = 300; // 5 minutes countdown
  let countdownActive = false;

  const popup = document.getElementById("sessionPopup");
  const overlay = document.getElementById("sessionPopupOverlay");
  const popupCountdown = document.getElementById("popupCountdown");

  // Reset activity
  function resetActivity() {
      idleTime = 0;

      if (countdownActive) {
          countdownActive = false;
          logoutTimer = 300; // Reset timer
          popup.style.display = "none";
          overlay.style.display = "none";
      }
  }

  // Stay logged-in button
  function stayLoggedIn() {
      resetActivity();
  }

  // Listeners
  window.onload = resetActivity;
  document.onmousemove = resetActivity;
  document.onkeypress = resetActivity;
  document.onclick = resetActivity;
  document.onscroll = resetActivity;

  // Timer loop
  setInterval(function () {
      idleTime++;

      // Start popup countdown
      if (idleTime >= idleLimit && !countdownActive) {
          countdownActive = true;
          popup.style.display = "block";
          overlay.style.display = "block";
      }

      if (countdownActive) {
          let minutes = Math.floor(logoutTimer / 60);
          let seconds = logoutTimer % 60;

          popupCountdown.innerHTML =
              String(minutes).padStart(2, "0") + ":" +
              String(seconds).padStart(2, "0");

          logoutTimer--;

          if (logoutTimer <= 0) {
              window.location.href = "{% url 'user_login' %}";
          }
      }
  }, 1000);
</script>
<script>
  const chartLabels = {{ chart_labels|safe }};
  const revenueData = {{ chart_revenue|safe }};
  const expenseData = {{ chart_expenses|safe }};
  const inventoryData = {{ chart_inventory|safe }};
</script>
<script>
    //REVENUE TREND CHART
    new Chart(document.getElementById('revenueChart'), {
      type: 'line',
      data: {
        labels: {{ chart_labels|default:"['Jan','Feb','Mar','Apr','May']"|safe }},
        datasets: [{
          label: 'Revenue',
          data: {{ chart_revenue|default:"[0,0,0,0,0]"|safe }},
          borderWidth: 2,
          tension: 0.4
        }]
      }
    });

    //COST BREAKDOWN CHART
    new Chart(document.getElementById('costChart'), {
      type: 'bar',
      data: {
        labels: ['Labor','Packaging','Transport','Utility','Tech'],
        datasets: [{
          label: 'Cost',
          data: {{ chart_costs|default:"[0,0,0,0,0]"|safe }},
        }]
      }
    });

    //INVENTORY VALUE CHART
    new Chart(document.getElementById('inventoryChart'), {
      type: 'line',
      data: {
        labels: {{ chart_labels|default:"['Jan','Feb','Mar','Apr','May']"|safe }},
        datasets: [{
          label: 'Inventory Value',
          data: {{ chart_inventory|default:"[0,0,0,0,0]"|safe }},
          borderWidth: 2,
          tension: 0.4
        }]
      }
    });
</script>


<script src="{% static 'js/user/finance.js' %}"></script>

{% endblock %}