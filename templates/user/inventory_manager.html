{% extends 'base_user.html' %}
{% load static i18n %}

{% block title %}{% trans "Inventory Dashboard" %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/user/inventory_manager/Inventory_manager.css' %}">
<link rel="stylesheet" href="{% static 'css/user_dashboard_table.css' %}">
{% endblock %}

{% block content %}


<div class="dashboard-section">  
  <div class="im-cards">

    <!-- INBOUND ITEMS -->
    <div class="im-card fade-up">
      <div class="maint-card-bubble"></div>
        <div class="im-card-image">
          <img src="{% static 'images/total-sku.png' %}" alt="card-image">
        </div>
        <div class="im-info">
          <h4>{% trans "Total SKUs" %}</h4>
          <p class="im-number">{{ total_skus|default:"0" }}</p>
          <span class="im-sub">
            {% trans "Active items in inventory" %}
          </span>
        </div>
    </div>

    <!-- PUTAWAY TASKS -->
    <div class="im-card fade-up delay-1">
      <div class="maint-card-bubble"></div>
        <div class="im-card-image">
          <img src="{% static 'images/storekeeper-img.png' %}" alt="card-image">
        </div>
        <div class="im-info">
          <h4>{% trans "Available Quantity" %}</h4>
          <p class="im-number">{{ available_quantity|default:"0" }}</p>
          <span class="im-sub">
            {% trans "Ready for dispatch" %}
          </span>
        </div>
    </div>

    <div class="im-card fade-up delay-1">
      <div class="maint-card-bubble"></div>
        <div class="im-card-image">
          <img src="{% static 'images/quality-pending.png' %}" alt="card-image">
        </div>
        <div class="im-info">
          <h4>{% trans "GRNs Pending QC" %}</h4>
          <p class="im-number">{{ grn_pending_qc|default:"0" }}</p>
          <span class="im-sub">
            {% trans "Received today:" %} {{ grn_today|default:"0" }}
          </span>
        </div>
    </div>

    <!-- LOW STOCK ALERTS -->
    <div class="im-card fade-up delay-2">
      <div class="maint-card-bubble"></div>
        <div class="im-card-image">
          <img src="{% static 'images/inventory-value.png' %}" alt="card-image">
        </div>
        <div class="im-info">
          <h4>{% trans "Inventory Value" %}</h4>
          <p class="im-number">₹ {{ inventory_value|default:"0" }}</p>
          <span class="im-sub">
            {% trans "Current stock worth" %}
          </span>
        </div>
    </div>
  </div>
  
    
<!----------------- inventory health widgets  -------------------->

  <section class="inventory-health">

    <div class="health-header">
      <h2>Inventory Health</h2>
      <p>Stock distribution overview and FIFO / FEFO compliance status</p>
    </div>

    <div class="health-grid">

      <!-- STOCK DISTRIBUTION -->
      <div class="health-card stock-distribution">
        <h3>Stock Distribution</h3>

        <div class="stock-list">

          <div class="stock-item available">
            <span class="dot"></span>
            <span class="label">Available</span>
            <span class="value">12,450</span>
          </div>

          <div class="stock-item reserved">
            <span class="dot"></span>
            <span class="label">Reserved</span>
            <span class="value">3,280</span>
          </div>

          <div class="stock-item qc">
            <span class="dot"></span>
            <span class="label">QC Hold</span>
            <span class="value">640</span>
          </div>

          <div class="stock-item scrap">
            <span class="dot"></span>
            <span class="label">Scrap</span>
            <span class="value">120</span>
          </div>

        </div>
      </div>

      <!-- FIFO / FEFO COMPLIANCE -->
      <div class="health-card fifo-compliance">
        <h3>FIFO / FEFO Compliance</h3>

        <div class="compliance-wrap">

          <div class="compliance-meter">
            <svg viewBox="0 0 36 36">
              <path class="bg"
                d="M18 2.0845
                  a 15.9155 15.9155 0 0 1 0 31.831
                  a 15.9155 15.9155 0 0 1 0 -31.831" />
              <path class="progress"
                stroke-dasharray="92, 100"
                d="M18 2.0845
                  a 15.9155 15.9155 0 0 1 0 31.831
                  a 15.9155 15.9155 0 0 1 0 -31.831" />
            </svg>
            <div class="percentage">92%</div>
            <center><p>Following FIFO</p></center>
          </div>

          <div class="violation-box">
            <h4>Violations</h4>
            <p class="violation-count">7</p>
            <span class="violation-sub">This month</span>
          </div>

        </div>
      </div>

    </div>
  </section>


<!----------------------- inventory chart  ------------------------>
  <section class="inventory-trends">

    <div class="trend-header">
      <h2>Inventory Trends</h2>
      <p>Stock movement, value changes, adjustments, and dead stock analysis</p>
    </div>

    <div class="trend-grid">

      <div class="trend-card">
        <h3>Stock In vs Stock Out</h3>
        <div class="chart-wrap">
          <canvas id="stockInOutChart"></canvas>
        </div>
      </div>

      <div class="trend-card">
        <h3>Inventory Value Trend</h3>
        <div class="chart-wrap">
          <canvas id="inventoryValueChart"></canvas>
        </div>
      </div>

      <div class="trend-card">
        <h3>Stock Adjustments</h3>
        <div class="chart-wrap">
          <canvas id="adjustmentsChart"></canvas>
        </div>
      </div>

      <div class="trend-card">
        <h3>Slow / Dead Stock %</h3>
        <div class="chart-wrap">
          <canvas id="deadStockChart"></canvas>
        </div>
      </div>

    </div>
  </section>

  
<!-------------------- recent activities table ------------------>
  <div class="recent-activities">
      <h2>{% trans "Recent Activities" %}</h2>
    <!-- TABLE PREVIEW SECTION -->
    <div class="dashboard-table-wrap">

      <div class="table-scroll">
        <table class="dashboard-table">
          <thead>
            <tr>
              <th>Activity</th>
              <th>SKU / Item</th>
              <th>Qty</th>
              <th>Status</th>
              <th>Time</th>
            </tr>
          </thead>

          <tbody>
            <tr>
              <td>GRN Posted</td>
              <td>SKU-10021 · LED Monitor</td>
              <td>+120</td>
              <td><span class="badge success">Updated</span></td>
              <td>09:10 AM</td>
            </tr>

            <tr>
              <td>Stock Adjusted</td>
              <td>SKU-10008 · Keyboard</td>
              <td>-5</td>
              <td><span class="badge info">Adjusted</span></td>
              <td>10:25 AM</td>
            </tr>

            <tr>
              <td>Low Stock Triggered</td>
              <td>SKU-10014 · Mouse</td>
              <td>8 Left</td>
              <td><span class="badge warning">Alert</span></td>
              <td>11:40 AM</td>
            </tr>

            <tr>
              <td>Cycle Count Done</td>
              <td>SKU-10032 · Router</td>
              <td>Verified</td>
              <td><span class="badge success">Completed</span></td>
              <td>Yesterday</td>
            </tr>

            <tr>
              <td>Damaged Stock Logged</td>
              <td>SKU-10005 · Power Cable</td>
              <td>-3</td>
              <td><span class="badge danger">Damaged</span></td>
              <td>Yesterday</td>
            </tr>
            <!-- Empty state -->
            <!--
            <tr>
              <td colspan="5" class="no-box">No Recent activities yet.</td>
            </tr>
            -->
          </tbody>
        </table>
      </div>
    </div>  
  </div>
</div>



<!-- SESSION TIMER BOX -->
<!-- SESSION EXPIRY POPUP -->
<div id="sessionPopupOverlay"
   style="
      display:none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(2px);
      z-index: 9998;
   ">
</div>

<div id="sessionPopup"
   style="
      display:none;
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 25px 35px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.3);
      text-align: center;
      z-index: 9999;
      width: 340px;
   ">
  <h3 style="margin-bottom: 10px; color:#b30000;">Session Expiring</h3>
  <p style="margin-bottom: 10px;">
      You have been inactive. You will be logged out in:
  </p>

  <div style="
      font-size: 28px;
      font-weight: bold;
      color: #d00000;
      margin-bottom: 15px;
  ">
      <span id="popupCountdown">05:00</span>
  </div>

  <button onclick="stayLoggedIn()" style="
      padding: 8px 20px;
      background: #007bff;
      border: none;
      color: white;
      border-radius: 8px;
      font-size: 15px;
      cursor: pointer;
  ">Stay Logged In</button>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  let idleTime = 0;
  const idleLimit = 120; // 2 minutes inactivity
  let logoutTimer = 300; // 5 minutes countdown
  let countdownActive = false;

  const popup = document.getElementById("sessionPopup");
  const overlay = document.getElementById("sessionPopupOverlay");
  const popupCountdown = document.getElementById("popupCountdown");

  // Reset activity
  function resetActivity() {
      idleTime = 0;

      if (countdownActive) {
          countdownActive = false;
          logoutTimer = 300; // Reset timer
          popup.style.display = "none";
          overlay.style.display = "none";
      }
  }

  // Stay logged-in button
  function stayLoggedIn() {
      resetActivity();
  }

  // Listeners
  window.onload = resetActivity;
  document.onmousemove = resetActivity;
  document.onkeypress = resetActivity;
  document.onclick = resetActivity;
  document.onscroll = resetActivity;

  // Timer loop
  setInterval(function () {
      idleTime++;

      // Start popup countdown
      if (idleTime >= idleLimit && !countdownActive) {
          countdownActive = true;
          popup.style.display = "block";
          overlay.style.display = "block";
      }

      if (countdownActive) {
          let minutes = Math.floor(logoutTimer / 60);
          let seconds = logoutTimer % 60;

          popupCountdown.innerHTML =
              String(minutes).padStart(2, "0") + ":" +
              String(seconds).padStart(2, "0");

          logoutTimer--;

          if (logoutTimer <= 0) {
              window.location.href = "{% url 'user_login' %}";
          }
      }
  }, 1000);
</script>
<script src="{% static 'js/user/inventory_manager.js' %}"></script>

  

{% endblock %}






