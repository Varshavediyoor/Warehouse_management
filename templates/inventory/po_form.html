{% extends 'base_user.html' %}
{% load static i18n %}

{% block title %}
{% if po %}Edit{% else %}Create{% endif %} Purchase Order
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/user/purchase/po_form.css' %}">
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
{% endblock %}

{% block content %}

<div class="po-container">

    <!-- ===== HEADER ===== -->
    <div class="wh-header-section">
        <div class="wh-header-left">
            <h1>
                <span>{% if po %}Edit{% else %}Create{% endif %}</span>
                {% trans " Purchase Order" %}
            </h1>
        </div>
        <div class="wh-header-right">
            {% if po %}
            <span class="po-badge {{ po.status|lower }}">
                {{ po.status }}
            </span>
            {% endif %}
            <a href="javascript:history.back()" class="btn-back">
                <i class="bi bi-arrow-left"></i> {% trans "Back" %}
            </a>
        </div>
    </div>

    <!-- ===== PO DETAILS CARD ===== -->
    <div class="po-card">
        <h3 class="po-card-title">Purchase Order Details</h3>

        <form method="post" class="po-form-grid">
            {% csrf_token %}

            <div class="po-input-group">
                <label>Vendor</label>
                <select name="vendor" required {% if po and po.status != "DRAFT" %}disabled{% endif %}>
                    <option value="">-- Select Vendor --</option>
                    {% for v in vendors %}
                    <option value="{{ v.id }}" {% if po and po.vendor_id == v.id %}selected{% endif %}>
                        {{ v.vendor_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="po-input-group">
                <label>Order Date</label>
                <input type="date"
                       name="order_date"
                       value="{{ po.order_date|date:'Y-m-d' }}"
                       required
                       {% if po and po.status != "DRAFT" %}disabled{% endif %}>
            </div>

            <div class="po-input-group po-span-2">
                <label>Remarks</label>
                <textarea name="remarks" rows="3"
                    {% if po and po.status != "DRAFT" %}disabled{% endif %}>{{ po.remarks }}</textarea>
            </div>

            {% if not po or po.status == "DRAFT" %}
            <div class="po-actions po-span-2">
                <button type="submit" class="po-btn-primary">
                    Save Purchase Order
                </button>
            </div>
            {% endif %}
        </form>
    </div>

    {% if po %}
    <!-- ===== ADD ITEMS CARD ===== -->
    <div class="po-card">
        <h3 class="po-card-title">
            Add Items to PO {{ po.po_number }}
        </h3>

        <form method="post" class="po-item-grid">
            {% csrf_token %}
            <input type="hidden" name="add_item" value="1">

            <select name="category" required>
                <option value="">Category</option>
                {% for c in categories %}
                <option value="{{ c.id }}">{{ c.name }}</option>
                {% endfor %}
            </select>

            <select name="product" required>
                <option value="">Product</option>
                {% for p in products %}
                <option value="{{ p.id }}">{{ p.name }}</option>
                {% endfor %}
            </select>

            <select name="category_variant" class="multi-select" multiple>
                {% for cv in category_variants %}
                <option value="{{ cv.id }}">{{ cv.name }}</option>
                {% endfor %}
            </select>

            <select name="product_variant" class="multi-select" multiple>
                {% for pv in product_variants %}
                <option value="{{ pv.id }}">{{ pv.value }}</option>
                {% endfor %}
            </select>

            <input type="number" name="quantity" min="1" required placeholder="Qty">

            {% if po.status == "DRAFT" %}
            <button type="submit" class="po-btn-accent">
                + Add Item
            </button>
            {% endif %}
        </form>
    </div>

    <!-- ===== ITEMS TABLE ===== -->
    <div class="po-card">
        <h3 class="po-card-title">Purchase Order Items</h3>

        <div class="po-table-wrapper">
            <table class="po-table">
                <thead>
                    <tr>
                        <th>Category</th>
                        <th>Product</th>
                        <th>Variants</th>
                        <th class="qty">Qty</th>
                    </tr>
                </thead>
                <tbody>
                    {% for i in items %}
                    <tr>
                        <td>{{ i.category }}</td>
                        <td>{{ i.product }}</td>
                        <td>
                            {% for cv in i.category_variant.all %}
                                <span class="po-chip">
                                    {{ cv.name }}
                                </span>
                            {% endfor %}
                            {% for pv in i.product_variant.all %}
                                <span class="po-chip accent">
                                    {{ pv.value }}
                                </span>
                            {% endfor %}
                        </td>
                        <td class="qty">{{ i.quantity }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="po-empty">
                            No items added
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    {% if po.status == "DRAFT" %}
    <!-- ===== SUBMIT BAR ===== -->
    <div class="po-submit-bar">
        <a href="{% url 'po_submit' po.id %}" class="po-btn-primary big">
            Submit Purchase Order
        </a>
    </div>
    {% endif %}
    {% endif %}

</div>

{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
$(document).ready(function () {
    $('.multi-select').select2({
        placeholder: "Select options",
        allowClear: true,
        width: '100%'
    });
});
</script>
{% endblock %}
