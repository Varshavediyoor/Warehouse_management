{% extends 'base_admin.html' %}
{% load static i18n %}

{% block title %}{% trans "Dispatch Report" %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/admin/purchase_report.css' %}">
<link rel="stylesheet" href="{% static 'css/admin/admin_report_table.css' %}">
{% endblock %}

{% block content %}
<div class="purchase-report-container">
  <!-- header  -->
  <div class="wh-header-section">
    <div class="wh-header-left">
        <h1><span>{% trans "Dispatch" %}</span> {% trans "Report" %}</h1>
        <p class="subtext">{% trans "Detailed summary of all dispatched orders and delivery statuses." %}</p>
    </div>
    <div class="wh-header-right">          
        <a href="{% url 'admin_reports' %}" class="btn-back">
            <i class="bi bi-arrow-left"></i> {% trans "Back" %}
        </a>
    </div>
  </div>

  <!-- Filter/Search -->
  <form method="GET" class="filter-form">
    <input type="text" name="search" placeholder="Search by Order No, Delivery Partner, Destination..." value="{{ search_query }}">
    <select name="status">
      <option value="">{% trans "All Statuses" %}</option>
      <option value="In Transit" {% if status_filter == "In Transit" %}selected{% endif %}>{% trans "In Transit" %}</option>
      <option value="Delivered" {% if status_filter == "Delivered" %}selected{% endif %}>{% trans "Delivered" %}</option>
    </select>
    <button type="submit">{% trans "Filter" %}</button>
  </form>

  <div class="report-meta">
    <div class="report-meta-content-left">
      <span class="records-count">{% trans "Total Records:" %} <strong>{{ dispatches|length }}</strong></span>
      <span class="generated-date"><i class="bi bi-clock"></i> {% trans "Generated on:" %} {{ generated_on|date:"d M Y, H:i" }}</span>
    </div>

    <div class="report-meta-content-right">
      <a href="{% url 'dispatch_report_excel' %}" class="action-btn excel">
        <i class="bi bi-file-earmark-excel"></i>{% trans "Download Excel" %}
      </a>
      <a href="{% url 'dispatch_report_pdf' %}" class="action-btn pdf">
        <i class="bi bi-file-earmark-pdf"></i>{% trans "Download PDF" %}
      </a>
    </div>
  </div>

  <div class="table-scroll-wrapper">
  <div class="table-container">
    <table class="report-table" id="reportTable">
      <thead>
        <tr>
          <th>{% trans "Dispatch ID" %}</th>
          <th>{% trans "Order No" %}</th>
          <th>{% trans "Delivery Partner" %}</th>
          <th>{% trans "Tracking / Vehicle No" %}</th>
          <th>{% trans "Dispatch Date" %}</th>
          <th>{% trans "Destination" %}</th>
          <th>{% trans "Status" %}</th>
        </tr>
      </thead>
<tbody>
{% for d in dispatches %}
<tr>
  {% with order=d.orders.first %}
  <td>{{ d.id }}</td>
  <td>{{ order.order_no|default:"-" }}</td>
  <td>{{ d.carrier_name|default:"-" }}</td>
  <td>{{ d.tracking_number|default:"-" }}</td>
  <td>{{ d.dispatch_date|date:"Y-m-d" }}</td>
  <td>{{ order.customer_address|default:"-" }}</td>
  <td>
    {% if order %}
      {% with picklist=order.picklist_set.first %}
        {% if picklist and picklist.delivery_assignments %}
          {% for da in picklist.delivery_assignments %}
            <span class="status-badge {% if da.delivery_status == 'Delivered' %}received{% else %}pending{% endif %}">
              {{ da.delivery_status }}
            </span>
          {% endfor %}
        {% else %}
          <span class="status-badge pending">In Transit</span>
        {% endif %}
      {% endwith %}
    {% else %}
      <span class="status-badge pending">In Transit</span>
    {% endif %}
  </td>
  {% endwith %}
</tr>
{% empty %}
<tr><td colspan="7" class="no-data">{% trans "No Dispatch Records Found" %}</td></tr>
{% endfor %}
</tbody>

    </table>
    <!-- Pagination Controls -->
    <div class="pagination-container" id="tablePagination"></div>
  </div>
</div>
</div>
{% endblock %}


{% block scripts %}
<script src="{% static 'js/admin/admin_report_tables.js' %}"></script>
{% endblock %}