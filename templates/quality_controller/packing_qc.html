{% extends 'base_user.html' %}
{% load static i18n %}

{% block title %}{% trans "Packing QC" %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/user/quality/inbound_qc.css' %}">

<style>
/* CAMERA MODAL */
.camera-modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}

.camera-box {
    width: 100%;
    max-width: 620px;
    background: #000;
    border-radius: 12px;
    overflow: hidden;
}

#camera-video,
#camera-canvas {
    width: 100%;
}

.camera-actions {
    display: flex;
    justify-content: space-around;
    padding: 10px;
    background: #111;
}

.camera-actions button {
    padding: 8px 14px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    font-size: 14px;
}

.capture-btn { background: #2c8cfb; color: #fff; }
.confirm-btn { background: #28a745; color: #fff; }
.retake-btn  { background: #ffc107; }
.cancel-btn  { background: #dc3545; color: #fff; }
</style>
{% endblock %}

{% block content %}

<div class="qc-page">

    <!-- HEADER -->
    <div class="wh-header-section">
        <div class="wh-header-left">
            <h1>
                <span>{% trans "Packing QC - " %}</span>
                {% trans "GRN" %} {{ grn.id }}
            </h1>
        </div>
        <div class="wh-header-right">
            <a href="javascript:history.back()" class="btn-back">
                <i class="bi bi-arrow-left"></i> {% trans "Back" %}
            </a>
        </div>
    </div>

    <div class="qc-card">

        <!-- INFO -->
        <div class="qc-info">
            <img src="{% static 'images/total-sku.png' %}">
            <h3>{% trans "Packing Quality Check" %}</h3>
            <p>
                {% trans "Verify carton condition, cushioning, labeling, weight and documents before outbound QC." %}
            </p>
        </div>

        <!-- FORM -->
        <form method="post" enctype="multipart/form-data" class="qc-form">
            {% csrf_token %}

            <div class="form-grid">

                <!-- Carton -->
                <div class="qc-item">
                    <div class="qc-check">
                        <input type="checkbox" name="carton_ok">
                        <label>{% trans "Carton OK" %}</label>
                    </div>
                    <div class="qc-image">
                        <img id="carton-preview" class="preview-img" hidden>
                        <button type="button" class="camera-btn" onclick="openCamera('carton')">
                            ðŸ“· {% trans "Take Photo" %}
                        </button>
                        <input type="file" name="carton_image" id="carton-input" hidden>
                    </div>
                </div>

                <!-- Cushioning -->
                <div class="qc-item">
                    <div class="qc-check">
                        <input type="checkbox" name="cushioning_ok">
                        <label>{% trans "Cushioning OK" %}</label>
                    </div>
                    <div class="qc-image">
                        <img id="cushioning-preview" class="preview-img" hidden>
                        <button type="button" class="camera-btn" onclick="openCamera('cushioning')">
                            ðŸ“· {% trans "Take Photo" %}
                        </button>
                        <input type="file" name="cushioning_image" id="cushioning-input" hidden>
                    </div>
                </div>

                <!-- Fragile Label -->
                <div class="qc-item">
                    <div class="qc-check">
                        <input type="checkbox" name="fragile_label">
                        <label>{% trans "Fragile Label Applied" %}</label>
                    </div>
                    <div class="qc-image">
                        <img id="fragile-preview" class="preview-img" hidden>
                        <button type="button" class="camera-btn" onclick="openCamera('fragile')">
                            ðŸ“· {% trans "Take Photo" %}
                        </button>
                        <input type="file" name="fragile_label_image" id="fragile-input" hidden>
                    </div>
                </div>

                <!-- Weight -->
                <div class="qc-item">
                    <div class="qc-check">
                        <input type="checkbox" name="weight_ok">
                        <label>{% trans "Weight Verified" %}</label>
                    </div>
                    <div class="qc-image">
                        <img id="weight-preview" class="preview-img" hidden>
                        <button type="button" class="camera-btn" onclick="openCamera('weight')">
                            ðŸ“· {% trans "Take Photo" %}
                        </button>
                        <input type="file" name="weight_image" id="weight-input" hidden>
                    </div>
                </div>

                <!-- Customer Label -->
                <div class="qc-item">
                    <div class="qc-check">
                        <input type="checkbox" name="customer_label_ok">
                        <label>{% trans "Customer Label OK" %}</label>
                    </div>
                    <div class="qc-image">
                        <img id="customer-preview" class="preview-img" hidden>
                        <button type="button" class="camera-btn" onclick="openCamera('customer')">
                            ðŸ“· {% trans "Take Photo" %}
                        </button>
                        <input type="file" name="customer_label_image" id="customer-input" hidden>
                    </div>
                </div>

                <!-- Documents -->
                <div class="qc-item">
                    <div class="qc-check">
                        <input type="checkbox" name="documents_added">
                        <label>{% trans "Documents Added" %}</label>
                    </div>
                    <div class="qc-image">
                        <img id="documents-preview" class="preview-img" hidden>
                        <button type="button" class="camera-btn" onclick="openCamera('documents')">
                            ðŸ“· {% trans "Take Photo" %}
                        </button>
                        <input type="file" name="documents_image" id="documents-input" hidden>
                    </div>
                </div>

            </div>

            <div class="form-actions">
                <button type="submit" class="action-btn submit">
                    {% trans "Submit & Continue" %}
                </button>
            </div>

        </form>
    </div>
</div>

<!-- CAMERA MODAL -->
<div class="camera-modal" id="camera-modal">
    <div class="camera-box">
        <video id="camera-video" autoplay playsinline></video>
        <canvas id="camera-canvas" hidden></canvas>

        <div class="camera-actions">
            <button class="cancel-btn" onclick="closeCamera()">âœ– Cancel</button>
            <button class="retake-btn" id="retakeBtn" onclick="retakePhoto()" hidden>ðŸ”„ Retake</button>
            <button class="confirm-btn" id="confirmBtn" onclick="confirmPhoto()" hidden>Confirm</button>
            <button class="capture-btn" id="captureBtn" onclick="capturePhoto()">ðŸ“¸ Capture</button>
        </div>
    </div>
</div>

<script>
let stream = null;
let activeInput = null;
let activePreview = null;

const cameraModal = document.getElementById("camera-modal");
const cameraVideo = document.getElementById("camera-video");
const cameraCanvas = document.getElementById("camera-canvas");

const captureBtn = document.getElementById("captureBtn");
const confirmBtn = document.getElementById("confirmBtn");
const retakeBtn  = document.getElementById("retakeBtn");

function openCamera(prefix) {
    activeInput = document.getElementById(prefix + "-input");
    activePreview = document.getElementById(prefix + "-preview");

    cameraModal.style.display = "flex";

    navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: "environment" } },
        audio: false
    }).then(s => {
        stream = s;
        cameraVideo.srcObject = stream;
        cameraVideo.play();
    });
}

function capturePhoto() {
    cameraCanvas.width = cameraVideo.videoWidth;
    cameraCanvas.height = cameraVideo.videoHeight;
    cameraCanvas.getContext("2d").drawImage(cameraVideo, 0, 0);

    cameraVideo.hidden = true;
    cameraCanvas.hidden = false;

    captureBtn.hidden = true;
    confirmBtn.hidden = false;
    retakeBtn.hidden = false;
}

function confirmPhoto() {
    cameraCanvas.toBlob(blob => {
        const file = new File([blob], "photo.jpg", { type: "image/jpeg" });
        const dt = new DataTransfer();
        dt.items.add(file);
        activeInput.files = dt.files;

        activePreview.src = URL.createObjectURL(file);
        activePreview.hidden = false;

        closeCamera();
    }, "image/jpeg", 0.9);
}

function retakePhoto() {
    cameraCanvas.hidden = true;
    cameraVideo.hidden = false;

    captureBtn.hidden = false;
    confirmBtn.hidden = true;
    retakeBtn.hidden = true;
}

function closeCamera() {
    cameraModal.style.display = "none";

    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
    }

    cameraVideo.hidden = false;
    cameraCanvas.hidden = true;

    captureBtn.hidden = false;
    confirmBtn.hidden = true;
    retakeBtn.hidden = true;
}
</script>

{% endblock %}
