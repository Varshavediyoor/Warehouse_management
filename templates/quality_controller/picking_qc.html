{% extends 'base_user.html' %}
{% load static i18n %}

{% block title %}{% trans "Picking QC" %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/user/quality/inbound_qc.css' %}">

<style>
/* CAMERA MODAL â€“ REQUIRED */
.camera-modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}

.camera-box {
    width: 100%;
    max-width: 620px;
    background: #000;
    border-radius: 12px;
    overflow: hidden;
}

#camera-video,
#camera-canvas {
    width: 100%;
}

.camera-actions {
    display: flex;
    justify-content: space-around;
    padding: 10px;
    background: #111;
}

.camera-actions button {
    padding: 8px 14px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    font-size: 14px;
}

.capture-btn { background: #2c8cfb; color: #fff; }
.confirm-btn { background: #28a745; color: #fff; }
.retake-btn  { background: #ffc107; }
.cancel-btn  { background: #dc3545; color: #fff; }
</style>
{% endblock %}

{% block content %}

<div class="qc-page">

    <!-- HEADER -->
    <div class="wh-header-section">
        <div class="wh-header-left">
            <h1>
                <span>{% trans "Picking QC - " %}</span>
                {% trans "GRN" %} {{ grn.id }}
            </h1>
        </div>
        <div class="wh-header-right">
            <a href="javascript:history.back()" class="btn-back">
                <i class="bi bi-arrow-left"></i> {% trans "Back" %}
            </a>
        </div>
    </div>

    <div class="qc-card">

        <!-- INFO -->
        <div class="qc-info">
            <img src="{% static 'images/total-sku.png' %}">
            <h3>{% trans "Picking Quality Check" %}</h3>
            <p>{% trans "Verify SKU, batch, quantity, expiry and barcode before packing." %}</p>
        </div>

        <!-- FORM -->
        <form method="post" enctype="multipart/form-data" class="qc-form">
            {% csrf_token %}

            <div class="form-grid">

                <!-- SKU -->
                <div class="qc-item">
                    <div class="qc-check">
                        <input type="checkbox" name="correct_sku">
                        <label>{% trans "Correct SKU" %}</label>
                    </div>
                    <div class="qc-image">
                        <img id="sku-preview" class="preview-img" hidden>
                        <button type="button" class="camera-btn" onclick="openCamera('sku')">
                            ðŸ“· {% trans "Take Photo" %}
                        </button>
                        <input type="file" name="correct_sku_image" id="sku-input" hidden>
                    </div>
                </div>

                <!-- Batch -->
                <div class="qc-item">
                    <div class="qc-check">
                        <input type="checkbox" name="correct_batch">
                        <label>{% trans "Correct Batch" %}</label>
                    </div>
                    <div class="qc-image">
                        <img id="batch-preview" class="preview-img" hidden>
                        <button type="button" class="camera-btn" onclick="openCamera('batch')">
                            ðŸ“· {% trans "Take Photo" %}
                        </button>
                        <input type="file" name="correct_batch_image" id="batch-input" hidden>
                    </div>
                </div>

                <!-- Quantity -->
                <div class="qc-item">
                    <div class="qc-check">
                        <input type="checkbox" name="correct_quantity">
                        <label>{% trans "Correct Quantity" %}</label>
                    </div>
                    <div class="qc-image">
                        <img id="quantity-preview" class="preview-img" hidden>
                        <button type="button" class="camera-btn" onclick="openCamera('quantity')">
                            ðŸ“· {% trans "Take Photo" %}
                        </button>
                        <input type="file" name="correct_quantity_image" id="quantity-input" hidden>
                    </div>
                </div>

                <!-- Expiry -->
                <div class="qc-item">
                    <div class="qc-check">
                        <input type="checkbox" name="expiry_ok">
                        <label>{% trans "Expiry OK" %}</label>
                    </div>
                    <div class="qc-image">
                        <img id="expiry-preview" class="preview-img" hidden>
                        <button type="button" class="camera-btn" onclick="openCamera('expiry')">
                            ðŸ“· {% trans "Take Photo" %}
                        </button>
                        <input type="file" name="expiry_image" id="expiry-input" hidden>
                    </div>
                </div>

                <!-- Barcode -->
                <div class="qc-item">
                    <div class="qc-check">
                        <input type="checkbox" name="barcode_scan">
                        <label>{% trans "Barcode Verified" %}</label>
                    </div>
                    <div class="qc-image">
                        <img id="barcode-preview" class="preview-img" hidden>
                        <button type="button" class="camera-btn" onclick="openCamera('barcode')">
                            ðŸ“· {% trans "Take Photo" %}
                        </button>
                        <input type="file" name="barcode_image" id="barcode-input" hidden>
                    </div>
                </div>

            </div>

            <div class="form-actions">
                <button type="submit" class="action-btn submit">
                    {% trans "Submit & Continue" %}
                </button>
            </div>

        </form>
    </div>
</div>

<!-- CAMERA MODAL -->
<div class="camera-modal" id="camera-modal">
    <div class="camera-box">
        <video id="camera-video" autoplay playsinline></video>
        <canvas id="camera-canvas" hidden></canvas>

        <div class="camera-actions">
            <button class="cancel-btn" onclick="closeCamera()">âœ– Cancel</button>
            <button class="retake-btn" id="retakeBtn" onclick="retakePhoto()" hidden>ðŸ”„ Retake</button>
            <button class="confirm-btn" id="confirmBtn" onclick="confirmPhoto()" hidden>Confirm</button>
            <button class="capture-btn" id="captureBtn" onclick="capturePhoto()">ðŸ“¸ Capture</button>
        </div>
    </div>
</div>

<script>
    let stream = null;
    let activeInput = null;
    let activePreview = null;
    
    const modal = document.getElementById("camera-modal");
    const video = document.getElementById("camera-video");
    const canvas = document.getElementById("camera-canvas");
    
    const captureBtn = document.getElementById("captureBtn");
    const confirmBtn = document.getElementById("confirmBtn");
    const retakeBtn  = document.getElementById("retakeBtn");
    
    function openCamera(prefix) {
        activeInput = document.getElementById(prefix + "-input");
        activePreview = document.getElementById(prefix + "-preview");
    
        modal.style.display = "flex";
    
        video.hidden = false;
        canvas.hidden = true;
    
        captureBtn.hidden = false;
        confirmBtn.hidden = true;
        retakeBtn.hidden = true;
    
        navigator.mediaDevices.getUserMedia({
            video: { facingMode: { ideal: "environment" } },
            audio: false
        }).then(s => {
            stream = s;
            video.srcObject = stream;
        }).catch(err => {
            alert("Camera access denied");
            closeCamera();
        });
    }
    
    function capturePhoto() {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
    
        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0);
    
        video.hidden = true;
        canvas.hidden = false;
    
        captureBtn.hidden = true;
        confirmBtn.hidden = false;
        retakeBtn.hidden = false;
    }
    
    function confirmPhoto() {
        canvas.toBlob(blob => {
            const file = new File([blob], "photo.jpg", { type: "image/jpeg" });
    
            const dt = new DataTransfer();
            dt.items.add(file);
            activeInput.files = dt.files;
    
            activePreview.src = URL.createObjectURL(file);
            activePreview.hidden = false;
    
            closeCamera();
        }, "image/jpeg", 0.9);
    }
    
    function retakePhoto() {
        canvas.hidden = true;
        video.hidden = false;
    
        captureBtn.hidden = false;
        confirmBtn.hidden = true;
        retakeBtn.hidden = true;
    }
    
    function closeCamera() {
        modal.style.display = "none";
    
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
    }
    </script>
    

{% endblock %}
