<style>
.container {
    max-width: 1100px;
    margin: 20px auto;
    font-family: Arial, sans-serif;
}

.card {
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 20px;
    margin-bottom: 25px;
}

.card h3 {
    margin-top: 0;
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
}

.form-row {
    display: flex;
    gap: 20px;
    margin-bottom: 15px;
}

.form-group {
    flex: 1;
}

label {
    font-weight: 600;
    display: block;
    margin-bottom: 5px;
}

input, select, textarea {
    width: 100%;
    padding: 8px;
}

button {
    padding: 8px 16px;
    background: #0d6efd;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

button:hover {
    background: #0b5ed7;
}

table {
    width: 100%;
    border-collapse: collapse;
}

table th {
    background: #f5f5f5;
}

table th, table td {
    padding: 10px;
    border: 1px solid #ddd;
}

.badge {
    background: #e9ecef;
    padding: 4px 8px;
    border-radius: 4px;
    margin-right: 5px;
    display: inline-block;
}
</style>


<!-- Select2 CSS--->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<!-- jQuery (required) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<div class="container">

<div class="card">
<h3>{% if po %}Edit{% else %}Create{% endif %} Purchase Order</h3>

<form method="post">
{% csrf_token %}

<div class="form-row">
    <div class="form-group">
        <label>Vendor</label>
        <select name="vendor" required {% if po and po.status != "DRAFT" %}disabled{% endif %}>
            <option value="">-- Select Vendor --</option>
            {% for v in vendors %}
            <option value="{{ v.id }}" {% if po and po.vendor_id == v.id %}selected{% endif %}>
                {{ v.vendor_name }}
            </option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group">
        <label>Order Date</label>
        <input type="date" name="order_date"
               value="{{ po.order_date|date:'Y-m-d' }}"
               required {% if po and po.status != "DRAFT" %}disabled{% endif %}>
    </div>
</div>

<div class="form-group">
    <label>Remarks</label>
    <textarea name="remarks" rows="3"
        {% if po and po.status != "DRAFT" %}disabled{% endif %}>{{ po.remarks }}</textarea>
</div>
<br>
{% if not po or po.status == "DRAFT" %}
<button type="submit">Save Purchase Order</button>
{% endif %}
</form>
</div>


{% if po %}
<div class="card">
<h3>Add Items to PO {{ po.po_number }}</h3>

<form method="post">
{% csrf_token %}
<input type="hidden" name="add_item" value="1">

<div class="form-row">
    <div class="form-group">
        <label>Category</label>
        <select name="category" id="category-select" required>
            <option value="">Select</option>
            {% for c in categories %}
                <option value="{{ c.id }}">{{ c.name }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group">
        <label>Product</label>
        <select name="product" id="product-select" required>
            <option value="">Select</option>

            {% for cat_id, prods in products_by_category.items %}
                {% for p in prods %}
                    <option value="{{ p.id }}"
                            data-category="{{ cat_id }}"
                            style="display:none;">
                        {{ p.name }}
                    </option>
                {% endfor %}
            {% endfor %}
        </select>
    </div>
</div>


<div class="card">
    <h4>Product Variants</h4>

    {% for product_id, variants in variants_by_product.items %}
        <div class="variant-group"
             data-product="{{ product_id }}"
             style="display:none;">

            {% for variant_name, values in variants.items %}
                <div class="form-group">
                    <label>{{ variant_name }}</label>
                    <select name="variant_{{ variant_name }}">
                        <option value="">Select {{ variant_name }}</option>
                        {% for v in values %}
                            <option value="{{ v.id }}">{{ v.value }}</option>
                        {% endfor %}
                    </select>
                </div>
            {% endfor %}

        </div>
    {% endfor %}
</div>


 
<div class="form-row">
    <div class="form-group">
        <label>Quantity</label>
        <input type="number" name="quantity" min="1" required>
    </div>
</div>

{% if po.status == "DRAFT" %}
<button type="submit">Add Item</button>
{% endif %}
</form>
</div>


<div class="card">
<h3>Items</h3>

<table>
<tr>
    <th>Category</th>
    <th>Product</th>
    <th>Variants</th>
    <th>Qty</th>
</tr>

{% for i in items %}
<tr>
    <td>{{ i.category }}</td>
    <td>{{ i.product }}</td>
    <td>
        {% for pv in i.product_variant.all %}
            <span class="badge">
                {{ pv.variant.name }} : {{ pv.value }}
            </span>
        {% empty %}
            <span class="badge">No variants</span>
        {% endfor %}
    </td>
    <td>{{ i.quantity }}</td>
</tr>
{% empty %}
<tr><td colspan="4">No items added</td></tr>
{% endfor %}
</table>

{% if po.status == "DRAFT" %}
<br>
<a href="{% url 'po_submit' po.id %}">Submit PO</a>
{% endif %}
</div>

{% endif %}
</div>

<script>
const categorySelect = document.getElementById("category-select");
const productSelect = document.getElementById("product-select");
const productOptions = productSelect.querySelectorAll("option[data-category]");
const variantGroups = document.querySelectorAll(".variant-group");

categorySelect.addEventListener("change", function () {
    const categoryId = this.value;

    productSelect.value = "";
    variantGroups.forEach(v => v.style.display = "none");

    productOptions.forEach(opt => {
        opt.style.display =
            opt.dataset.category === categoryId ? "block" : "none";
    });
});

productSelect.addEventListener("change", function () {
    const productId = this.value;

    variantGroups.forEach(group => {
        group.style.display =
            group.dataset.product === productId ? "block" : "none";
    });
});
</script>